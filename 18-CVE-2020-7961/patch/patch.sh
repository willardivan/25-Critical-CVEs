#!/bin/bash
# CVE-2020-7961 custom patch script
# upgrade to liferay-ce-portal-7.2.1-ga2
# put in the same folder with 'liferay-ce-portal-tomcat-7.2.1-ga2-20191111141448326.tar.gz'
#
# adjust with your env
# vn

# Old and New installation paths
OLD_PATH="/var/lib/liferay-portal"
NEW_PATH="/var/lib/liferay-ce-portal-7.2.1-ga2"

echo "[+] Creating new installation path..."
# Create new installation path if it doesn't exist
sudo mkdir -p $NEW_PATH

echo "[+] Extracting downloaded file to new path..."
# Extract the downloaded file to the new path
sudo tar -zxf /home/user/liferay-ce-portal-tomcat-7.2.1-ga2-20191111141448326.tar.gz -C /var/lib

echo "[+] Backing up and moving conf and data directories..."
# Backup and move the conf and data directories
sudo cp -R $OLD_PATH/tomcat-9.0.17/conf $NEW_PATH/tomcat-9.0.17/conf
sudo cp -R $OLD_PATH/data $NEW_PATH/data
sudo cp -R $OLD_PATH/portal-setup-wizard.properties $NEW_PATH/portal-setup-wizard.properties


echo "[+] Updating liferay.service file..."
# Update the liferay.service file
sudo sed -i "s|${OLD_PATH}|${NEW_PATH}|g" /etc/systemd/system/liferay.service

echo "[+] Reloading the systemd configuration..."
# Reload the systemd configuration
sudo systemctl daemon-reload

echo "[+] Restarting the liferay service..."
# Stop and start the service
sudo systemctl stop liferay.service
sudo systemctl start liferay.service

echo "[+] Patching completed successfully!"
echo "[*] Starting liferay service.. please wait a min.."