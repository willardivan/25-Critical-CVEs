#!/bin/bash
# CVE-2018-18925 Patch
# van0

# Menampilkan banner
echo "------------------------------------------------------"
echo "       MULAI PATCHING CVE-2018-18925 (GOGS RCE)       "
echo "------------------------------------------------------"

# Menghentikan layanan Gogs
echo "Menghentikan layanan Gogs..."
sudo service gogs stop

# Mengubah ke pengguna gogs dan menjalankan perintah sebagai pengguna tersebut
sudo -u gogs bash << EOF

# Mengubah ke direktori sumber gogs
echo 'Mengubah ke direktori sumber gogs...'
cd /opt/gogs/gogs-repo/src/github.com/gogs

# Membuat cadangan dari instalasi Gogs saat ini
echo 'Membuat cadangan dari instalasi Gogs saat ini...'
cp -r gogs gogs-backup && rm -rf gogs

# Mengunduh versi baru dari Gogs
echo 'Mengunduh versi baru dari Gogs...'
wget https://dl.gogs.io/0.11.86/gogs_0.11.86_linux_amd64.tar.gz

# Mengekstrak versi baru dan menghapus file yang diunduh
echo 'Mengekstrak versi baru dan menghapus file yang diunduh...'
tar -xzf gogs_0.11.86_linux_amd64.tar.gz && rm gogs_0.11.86_linux_amd64.tar.gz

# Menyalin direktori custom dari cadangan ke instalasi baru
echo 'Menyalin direktori custom dari cadangan ke instalasi baru...'
cp -r gogs-backup/custom gogs

EOF

# Memulai layanan Gogs
echo "Memulai layanan Gogs..."
sudo service gogs start

echo "--------------------------------------------------------"
echo "       PATCHING CVE-2018-18925 (GOGS RCE) SELESAI       "
echo "--------------------------------------------------------"